# GitHub Actions ì›Œí¬í”Œë¡œìš°: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ì„ EC2ì— ìžë™ ë°°í¬
name: Deploy Next.js to EC2

# íŠ¸ë¦¬ê±° ì¡°ê±´: develop ë¸Œëžœì¹˜ì— pushê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - develop

# ë°°í¬ ìž‘ì—… ì •ì˜
jobs:
  deploy:
    # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  Ubuntu ëŸ¬ë„ˆì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # Step 1: ì €ìž¥ì†Œ ì½”ë“œë¥¼ ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Node.js 18 í™˜ê²½ ì„¤ì • ë° npm ìºì‹œ í™œìš©
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'  # npm ì˜ì¡´ì„± ìºì‹œë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•

      # Step 3: í”„ë¡œë•ì…˜ìš© í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create environment file before build
        run: |
          # ë¹Œë“œ ì „ì— í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          # EC2_HOSTëŠ” GitHub Secretsì—ì„œ ê°€ì ¸ì˜´ (ë³´ì•ˆìƒ ìˆ¨ê²¨ì§„ ê°’)
          cat > .env.production << 'EOF'
          NEXT_PUBLIC_REDIRECT_TO=${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL=${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL=http://34.64.182.180:8080
          EOF

      # Step 4: Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (npm ciëŠ” package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë²„ì „ ì„¤ì¹˜)
      - name: Install dependencies
        run: npm ci

      # Step 5: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ í¬í•¨)
      - name: Build Next.js app with environment variables
        env:
          # ì• í”Œë¦¬ì¼€ì´ì…˜ URL ì„¤ì • (ì¸ì¦ ì½œë°± ë° í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ URL)
          NEXT_PUBLIC_REDIRECT_TO: ${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL: ${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL: http://34.64.182.180:8080
        run: npm run build

      # Step 6: ë°°í¬ìš© ì••ì¶• íŒŒì¼ ìƒì„±
      - name: Create deployment archive
        run: |
          # PM2 í”„ë¡œì„¸ìŠ¤ ë§¤ë‹ˆì € ì„¤ì • íŒŒì¼ ìƒì„±
          # PM2ëŠ” Node.js ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í”„ë¡œë•ì…˜ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë„êµ¬
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'nextjs-app',           # ì•± ì´ë¦„
              script: 'npm',                # ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
              args: 'start',                # npm start ëª…ë ¹ì–´ ì‹¤í–‰
              env: {
                NODE_ENV: 'production'      # í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •
              }
            }]
          };
          EOF
          
          # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ì„ tar.gzë¡œ ì••ì¶•
          # .next: ë¹Œë“œëœ Next.js íŒŒì¼
          # package.json, package-lock.json: ì˜ì¡´ì„± ì •ë³´
          # public: ì •ì  íŒŒì¼ë“¤
          # .env.production: í™˜ê²½ë³€ìˆ˜
          # ecosystem.config.js: PM2 ì„¤ì •
          tar -czf deployment.tar.gz .next package.json package-lock.json public .env.production ecosystem.config.js

      # Step 7: EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          # EC2 ì—°ê²° ì •ë³´ (ëª¨ë‘ GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # ê¸°ì¡´ PM2 í”„ë¡œì„¸ìŠ¤ ì™„ì „ ì œê±°
            pm2 delete all || true    # ëª¨ë“  PM2 ì•± ì‚­ì œ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            pm2 kill || true          # PM2 ë°ëª¬ ì¢…ë£Œ
            pm2 flush || true         # PM2 ë¡œê·¸ ì •ë¦¬
            
            # í¬íŠ¸ 3000ì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            # lsof: í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ID ì°¾ê¸°
            # fuser: í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            sudo lsof -ti:3000 | xargs sudo kill -9 || true
            sudo fuser -k 3000/tcp || true
            
            # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œë¥¼ ìœ„í•œ ëŒ€ê¸°
            sleep 3
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ë°±ì—… (ë¡¤ë°±ìš©)
            if [ -d "~/nextjs-app" ]; then
              cp -r ~/nextjs-app ~/nextjs-app-backup-$(date +%Y%m%d_%H%M%S)
            fi
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì •ë¦¬ í›„ ìž¬ìƒì„±
            rm -rf ~/nextjs-app
            mkdir -p ~/nextjs-app

      # Step 8: ì••ì¶•ëœ ë°°í¬ íŒŒì¼ì„ EC2ë¡œ ë³µì‚¬
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          source: "deployment.tar.gz"    # ë¡œì»¬ íŒŒì¼
          target: "/tmp/"                # EC2ì˜ ìž„ì‹œ ë””ë ‰í† ë¦¬ì— ë³µì‚¬

      # Step 9: EC2ì—ì„œ íŒŒì¼ ì••ì¶• í•´ì œ ë° ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ (PM2 ìžë™ ì‹œìž‘ ì„¤ì • í¬í•¨)
      - name: Extract and restart application with PM2 auto-startup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í›„ ì••ì¶• í•´ì œ
            cd ~/nextjs-app
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz      # ìž„ì‹œ íŒŒì¼ ì •ë¦¬
            
            # Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (í”„ë¡œë•ì…˜ìš©ë§Œ, ê°œë°œ ì˜ì¡´ì„± ì œì™¸)
            npm ci --omit=dev
            
            # í¬íŠ¸ 3000 ì‚¬ìš© ì—¬ë¶€ ìµœì¢… í™•ì¸
            if sudo netstat -tlnp | grep :3000; then
              echo "Port 3000 still in use, killing remaining processes"
              sudo lsof -ti:3000 | xargs sudo kill -9 || true
              sleep 2
            fi
            
            # PM2 ë°ëª¬ ì‹œìž‘ (í”„ë¡œì„¸ìŠ¤ ë§¤ë‹ˆì € ì´ˆê¸°í™”)
            pm2 ping
            
            # Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘
            # í¬íŠ¸ 3000ì´ ì‚¬ìš© ì¤‘ì´ë©´ 3001 í¬íŠ¸ ì‚¬ìš©
            if sudo ss -tulpn | grep -q :3000; then
              echo "Port 3000 in use, trying port 3001"
              pm2 start npm --name "nextjs-app" -- start -- --port 3001
            else
              pm2 start npm --name "nextjs-app" -- start
            fi
            
            # PM2 ì„¤ì • ì €ìž¥ ë° ìžë™ ì‹œìž‘ ì„¤ì •
            pm2 save    # PM2 ì„¤ì • ì €ìž¥ (ì„œë²„ ìž¬ì‹œìž‘ ì‹œ ìžë™ ì‹¤í–‰ìš©)
            
            # PM2 ìžë™ ì‹œìž‘ ì„¤ì • - ì‹œìŠ¤í…œ ìž¬ë¶€íŒ… ì‹œ PM2ê°€ ìžë™ìœ¼ë¡œ ì‹œìž‘ë˜ë„ë¡ ì„¤ì •
            echo "Setting up PM2 auto-startup..."
            
            # ê¸°ì¡´ startup ì„¤ì • ì œê±° (ìžˆë‹¤ë©´)
            pm2 unstartup systemd || true
            
            # ìƒˆë¡œìš´ startup ì„¤ì • ìƒì„± ë° ì ìš©
            STARTUP_CMD=$(pm2 startup systemd | grep "sudo env" | head -1)
            if [ ! -z "$STARTUP_CMD" ]; then
              echo "Executing startup command: $STARTUP_CMD"
              eval $STARTUP_CMD || echo "Warning: startup command failed, but continuing..."
            fi
            
            # ëŒ€ì•ˆ: ì§ì ‘ systemd ì„¤ì • (ìœ„ ë°©ë²•ì´ ì‹¤íŒ¨í•  ê²½ìš°)
            sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u $(whoami) --hp $(eval echo ~$(whoami)) || echo "Alternative startup setup failed, but continuing..."
            
            # PM2 ì„¤ì • ë‹¤ì‹œ ì €ìž¥ (startup ì„¤ì • í›„)
            pm2 save
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘ ëŒ€ê¸° ë° ìƒíƒœ í™•ì¸
            sleep 5
            pm2 list    # ì‹¤í–‰ ì¤‘ì¸ PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ì¶œë ¥
            
            # ë°°í¬ ì„±ê³µ ì—¬ë¶€ í™•ì¸
            if pm2 list | grep -q "online"; then
              echo "âœ… Next.js app started successfully!"
              # HTTP ìš”ì²­ìœ¼ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ë‹µ í™•ì¸
              curl -f http://localhost:3000 || echo "âš ï¸  App started but not responding to HTTP requests"
            else
              echo "âŒ Failed to start Next.js app"
              pm2 logs nextjs-app --lines 20    # ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì¶œë ¥
              exit 1
            fi
            
            # PM2 ìžë™ ì‹œìž‘ ì„¤ì • í™•ì¸
            echo "Checking PM2 startup configuration..."
            sudo systemctl status pm2-$(whoami) || echo "PM2 service not found - manual setup may be required"
            
            echo "ðŸŽ‰ Deployment completed successfully!"
            echo "ðŸ“ PM2 auto-startup configured - app will restart automatically after EC2 reboot"
            
            # Nginx ì›¹ì„œë²„ ì„¤ì • í™•ì¸ ë° ìž¬ì‹œìž‘ (í•„ìš”ì‹œ)
            # ì£¼ì„ ì²˜ë¦¬ë¨: sudo ê¶Œí•œì´ í•„ìš”í•œ ê²½ìš° sudoers ì„¤ì •ì´ ì„ í–‰ë˜ì–´ì•¼ í•¨
            # sudo nginx -t && sudo systemctl reload nginx