# GitHub Actions 워크플로우: Next.js 애플리케이션을 EC2에 자동 배포
name: Deploy Next.js to EC2

# 트리거 조건: develop 브랜치에 push가 발생할 때 실행
on:
  push:
    branches:
      - develop

# 배포 작업 정의
jobs:
  deploy:
    # GitHub가 제공하는 최신 Ubuntu 러너에서 실행
    runs-on: ubuntu-latest

    steps:
      # Step 1: 저장소 코드를 러너로 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Node.js 18 환경 설정 및 npm 캐시 활용
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'  # npm 의존성 캐시로 빌드 시간 단축

      # Step 3: 프로덕션용 환경변수 파일 생성
      - name: Create environment file before build
        run: |
          # 빌드 전에 환경변수 파일 생성
          # EC2_HOST는 GitHub Secrets에서 가져옴 (보안상 숨겨진 값)
          cat > .env.production << 'EOF'
          NEXT_PUBLIC_REDIRECT_TO=${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL=${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL=http://api.cymply.kr
          EOF

      # Step 4: Node.js 의존성 설치 (npm ci는 package-lock.json 기반으로 정확한 버전 설치)
      - name: Install dependencies
        run: npm ci

      # Step 5: Next.js 애플리케이션 빌드 (환경변수 포함)
      - name: Build Next.js app with environment variables
        env:
          # Supabase 설정 (데이터베이스 연결용)
          NEXT_PUBLIC_SUPABASE_URL: https://culheywadbntqpaigwnz.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1bGhleXdhZGJudHFwYWlnd256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDk1MjEsImV4cCI6MjA2MjYyNTUyMX0.BwSQnxSTbha1DD6uKftuDHX4JekA6oBDa9wjBVjoIn8
          # 애플리케이션 URL 설정 (인증 콜백 및 프론트엔드/백엔드 URL)
          NEXT_PUBLIC_REDIRECT_TO: ${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL: ${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL: http://api.cymply.kr
        run: npm run build

      # Step 6: 배포용 압축 파일 생성
      - name: Create deployment archive
        run: |
          # PM2 프로세스 매니저 설정 파일 생성
          # PM2는 Node.js 애플리케이션을 프로덕션에서 관리하는 도구
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'nextjs-app',           // 앱 이름
              script: 'npm',                // 실행할 스크립트
              args: 'start',                // npm start 명령어 실행
              env: {
                NODE_ENV: 'production'      // 프로덕션 환경 설정
              }
            }]
          };
          EOF
          
          # 배포에 필요한 파일들을 tar.gz로 압축
          # .next: 빌드된 Next.js 파일
          # package.json, package-lock.json: 의존성 정보
          # public: 정적 파일들
          # .env.production: 환경변수
          # ecosystem.config.js: PM2 설정
          tar -czf deployment.tar.gz .next package.json package-lock.json public .env.production ecosystem.config.js

      # Step 7: EC2 서버에 SSH 접속하여 기존 애플리케이션 정리
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          # EC2 연결 정보 (모두 GitHub Secrets에서 가져옴)
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # 기존 PM2 프로세스 완전 제거
            pm2 delete all || true    # 모든 PM2 앱 삭제 (실패해도 계속 진행)
            pm2 kill || true          # PM2 데몬 종료
            pm2 flush || true         # PM2 로그 정리
            
            # 포트 3000을 사용하는 모든 프로세스 강제 종료
            # lsof: 포트를 사용하는 프로세스 ID 찾기
            # fuser: 포트를 사용하는 프로세스 종료
            sudo lsof -ti:3000 | xargs sudo kill -9 || true
            sudo fuser -k 3000/tcp || true
            
            # 프로세스 종료 완료를 위한 대기
            sleep 3
            
            # 기존 애플리케이션 디렉토리 백업 (롤백용)
            if [ -d "~/nextjs-app" ]; then
              cp -r ~/nextjs-app ~/nextjs-app-backup-$(date +%Y%m%d_%H%M%S)
            fi
            
            # 애플리케이션 디렉토리 정리 후 재생성
            rm -rf ~/nextjs-app
            mkdir -p ~/nextjs-app

      # Step 8: 압축된 배포 파일을 EC2로 복사
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          source: "deployment.tar.gz"    # 로컬 파일
          target: "/tmp/"                # EC2의 임시 디렉토리에 복사

      # Step 9: EC2에서 파일 압축 해제 및 systemd 서비스로 자동 재시작 설정
      - name: Extract and setup auto-restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # 애플리케이션 디렉토리로 이동 후 압축 해제
            cd ~/nextjs-app
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz
            
            # Node.js 의존성 설치
            npm ci --omit=dev
            
            # 기존 서비스 정지 및 PM2 정리
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl stop nextjs-app || true
            pm2 delete all || true
            pm2 kill || true
            
            # 포트 사용 프로세스 정리
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S lsof -ti:3000 | xargs sudo kill -9 || true
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S fuser -k 3000/tcp || true
            sleep 3
            
            # systemd 서비스 파일 생성
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S tee /etc/systemd/system/nextjs-app.service > /dev/null <<EOF
            [Unit]
            Description=Next.js Application
            After=network.target
            Wants=network-online.target
            After=network-online.target
            
            [Service]
            Type=simple
            User=$(whoami)
            WorkingDirectory=/home/$(whoami)/nextjs-app
            ExecStart=/usr/bin/npm start
            Restart=always
            RestartSec=10
            Environment=NODE_ENV=production
            StandardOutput=journal
            StandardError=journal
            SyslogIdentifier=nextjs-app
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # systemd 서비스 활성화 및 시작
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl daemon-reload
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl enable nextjs-app.service
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl start nextjs-app.service
            
            # 서비스 시작 대기
            sleep 10
            
            # 서비스 상태 확인
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl status nextjs-app.service
            
            # 애플리케이션 응답 확인
            if curl -f http://localhost:3000 >/dev/null 2>&1; then
              echo "✅ Next.js app started successfully on port 3000!"
            else
              echo "❌ App not responding, checking logs..."
              echo ${{ secrets.EC2_PASSWORD }} | sudo -S journalctl -u nextjs-app.service --lines=20
              exit 1
            fi
            
            # 자동 시작 설정 확인
            if echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-enabled nextjs-app.service | grep -q "enabled"; then
              echo "✅ Auto-start on boot: ENABLED"
              echo "🎉 EC2 재부팅 시 자동으로 앱이 시작됩니다!"
            else
              echo "❌ Auto-start on boot: DISABLED"
              exit 1
            fi
            
            echo "🚀 Deployment completed successfully!"
            echo "📋 Service status:"
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-active nextjs-app.service
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-enabled nextjs-app.service