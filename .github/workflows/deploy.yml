# GitHub Actions ì›Œí¬í”Œë¡œìš°: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ì„ EC2ì— ìë™ ë°°í¬
name: Deploy Next.js to EC2

# íŠ¸ë¦¬ê±° ì¡°ê±´: develop ë¸Œëœì¹˜ì— pushê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰
on:
  push:
    branches:
      - develop

# ë°°í¬ ì‘ì—… ì •ì˜
jobs:
  deploy:
    # GitHubê°€ ì œê³µí•˜ëŠ” ìµœì‹  Ubuntu ëŸ¬ë„ˆì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # Step 1: ì €ì¥ì†Œ ì½”ë“œë¥¼ ëŸ¬ë„ˆë¡œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Node.js 18 í™˜ê²½ ì„¤ì • ë° npm ìºì‹œ í™œìš©
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'  # npm ì˜ì¡´ì„± ìºì‹œë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•

      # Step 3: í”„ë¡œë•ì…˜ìš© í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      - name: Create environment file before build
        run: |
          # ë¹Œë“œ ì „ì— í™˜ê²½ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          # EC2_HOSTëŠ” GitHub Secretsì—ì„œ ê°€ì ¸ì˜´ (ë³´ì•ˆìƒ ìˆ¨ê²¨ì§„ ê°’)
          cat > .env.production << 'EOF'
          NEXT_PUBLIC_REDIRECT_TO=${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL=${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL=http://api.cymply.kr
          EOF

      # Step 4: Node.js ì˜ì¡´ì„± ì„¤ì¹˜ (npm ciëŠ” package-lock.json ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•œ ë²„ì „ ì„¤ì¹˜)
      - name: Install dependencies
        run: npm ci

      # Step 5: Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í™˜ê²½ë³€ìˆ˜ í¬í•¨)
      - name: Build Next.js app with environment variables
        env:
          # Supabase ì„¤ì • (ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ìš©)
          NEXT_PUBLIC_SUPABASE_URL: https://culheywadbntqpaigwnz.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN1bGhleXdhZGJudHFwYWlnd256Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcwNDk1MjEsImV4cCI6MjA2MjYyNTUyMX0.BwSQnxSTbha1DD6uKftuDHX4JekA6oBDa9wjBVjoIn8
          # ì• í”Œë¦¬ì¼€ì´ì…˜ URL ì„¤ì • (ì¸ì¦ ì½œë°± ë° í”„ë¡ íŠ¸ì—”ë“œ/ë°±ì—”ë“œ URL)
          NEXT_PUBLIC_REDIRECT_TO: ${{ secrets.EC2_HOST }}/auth/callback
          NEXT_PUBLIC_FRONTEND_URL: ${{ secrets.EC2_HOST }}
          NEXT_PUBLIC_BACKEND_URL: http://api.cymply.kr
        run: npm run build

      # Step 6: ë°°í¬ìš© ì••ì¶• íŒŒì¼ ìƒì„±
      - name: Create deployment archive
        run: |
          # PM2 í”„ë¡œì„¸ìŠ¤ ë§¤ë‹ˆì € ì„¤ì • íŒŒì¼ ìƒì„±
          # PM2ëŠ” Node.js ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í”„ë¡œë•ì…˜ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë„êµ¬
          cat > ecosystem.config.js << 'EOF'
          module.exports = {
            apps: [{
              name: 'nextjs-app',           // ì•± ì´ë¦„
              script: 'npm',                // ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸
              args: 'start',                // npm start ëª…ë ¹ì–´ ì‹¤í–‰
              env: {
                NODE_ENV: 'production'      // í”„ë¡œë•ì…˜ í™˜ê²½ ì„¤ì •
              }
            }]
          };
          EOF
          
          # ë°°í¬ì— í•„ìš”í•œ íŒŒì¼ë“¤ì„ tar.gzë¡œ ì••ì¶•
          # .next: ë¹Œë“œëœ Next.js íŒŒì¼
          # package.json, package-lock.json: ì˜ì¡´ì„± ì •ë³´
          # public: ì •ì  íŒŒì¼ë“¤
          # .env.production: í™˜ê²½ë³€ìˆ˜
          # ecosystem.config.js: PM2 ì„¤ì •
          tar -czf deployment.tar.gz .next package.json package-lock.json public .env.production ecosystem.config.js

      # Step 7: EC2 ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ë¦¬
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          # EC2 ì—°ê²° ì •ë³´ (ëª¨ë‘ GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # ê¸°ì¡´ PM2 í”„ë¡œì„¸ìŠ¤ ì™„ì „ ì œê±°
            pm2 delete all || true    # ëª¨ë“  PM2 ì•± ì‚­ì œ (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
            pm2 kill || true          # PM2 ë°ëª¬ ì¢…ë£Œ
            pm2 flush || true         # PM2 ë¡œê·¸ ì •ë¦¬
            
            # í¬íŠ¸ 3000ì„ ì‚¬ìš©í•˜ëŠ” ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
            # lsof: í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ID ì°¾ê¸°
            # fuser: í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ
            sudo lsof -ti:3000 | xargs sudo kill -9 || true
            sudo fuser -k 3000/tcp || true
            
            # í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œë¥¼ ìœ„í•œ ëŒ€ê¸°
            sleep 3
            
            # ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ë°±ì—… (ë¡¤ë°±ìš©)
            if [ -d "~/nextjs-app" ]; then
              cp -r ~/nextjs-app ~/nextjs-app-backup-$(date +%Y%m%d_%H%M%S)
            fi
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ ì •ë¦¬ í›„ ì¬ìƒì„±
            rm -rf ~/nextjs-app
            mkdir -p ~/nextjs-app

      # Step 8: ì••ì¶•ëœ ë°°í¬ íŒŒì¼ì„ EC2ë¡œ ë³µì‚¬
      - name: Copy files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          source: "deployment.tar.gz"    # ë¡œì»¬ íŒŒì¼
          target: "/tmp/"                # EC2ì˜ ì„ì‹œ ë””ë ‰í† ë¦¬ì— ë³µì‚¬

      # Step 9: EC2ì—ì„œ íŒŒì¼ ì••ì¶• í•´ì œ ë° systemd ì„œë¹„ìŠ¤ë¡œ ìë™ ì¬ì‹œì‘ ì„¤ì •
      - name: Extract and setup auto-restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          password: ${{ secrets.EC2_PASSWORD }}
          port: 22
          script: |
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ í›„ ì••ì¶• í•´ì œ
            cd ~/nextjs-app
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz
            
            # Node.js ì˜ì¡´ì„± ì„¤ì¹˜
            npm ci --omit=dev
            
            # ê¸°ì¡´ ì„œë¹„ìŠ¤ ì •ì§€ ë° PM2 ì •ë¦¬
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl stop nextjs-app || true
            pm2 delete all || true
            pm2 kill || true
            
            # í¬íŠ¸ ì‚¬ìš© í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S lsof -ti:3000 | xargs sudo kill -9 || true
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S fuser -k 3000/tcp || true
            sleep 3
            
            # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S tee /etc/systemd/system/nextjs-app.service > /dev/null <<EOF
            [Unit]
            Description=Next.js Application
            After=network.target
            Wants=network-online.target
            After=network-online.target
            
            [Service]
            Type=simple
            User=$(whoami)
            WorkingDirectory=/home/$(whoami)/nextjs-app
            ExecStart=/usr/bin/npm start
            Restart=always
            RestartSec=10
            Environment=NODE_ENV=production
            StandardOutput=journal
            StandardError=journal
            SyslogIdentifier=nextjs-app
            
            [Install]
            WantedBy=multi-user.target
            EOF
            
            # systemd ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl daemon-reload
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl enable nextjs-app.service
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl start nextjs-app.service
            
            # ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸°
            sleep 10
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl status nextjs-app.service
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ë‹µ í™•ì¸
            if curl -f http://localhost:3000 >/dev/null 2>&1; then
              echo "âœ… Next.js app started successfully on port 3000!"
            else
              echo "âŒ App not responding, checking logs..."
              echo ${{ secrets.EC2_PASSWORD }} | sudo -S journalctl -u nextjs-app.service --lines=20
              exit 1
            fi
            
            # ìë™ ì‹œì‘ ì„¤ì • í™•ì¸
            if echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-enabled nextjs-app.service | grep -q "enabled"; then
              echo "âœ… Auto-start on boot: ENABLED"
              echo "ğŸ‰ EC2 ì¬ë¶€íŒ… ì‹œ ìë™ìœ¼ë¡œ ì•±ì´ ì‹œì‘ë©ë‹ˆë‹¤!"
            else
              echo "âŒ Auto-start on boot: DISABLED"
              exit 1
            fi
            
            echo "ğŸš€ Deployment completed successfully!"
            echo "ğŸ“‹ Service status:"
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-active nextjs-app.service
            echo ${{ secrets.EC2_PASSWORD }} | sudo -S systemctl is-enabled nextjs-app.service